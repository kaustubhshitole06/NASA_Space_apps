<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA Weather Probability Dashboard</title>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        #map { height: 400px; width: 100%; }
        .weather-card { 
            transition: transform 0.2s; 
            cursor: pointer;
        }
        .weather-card:hover { 
            transform: translateY(-5px); 
        }
        .probability-high { color: #dc3545; font-weight: bold; }
        .probability-medium { color: #ffc107; font-weight: bold; }
        .probability-low { color: #28a745; font-weight: bold; }
        .loading-spinner { 
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row bg-dark text-white py-3">
            <div class="col">
                <h1 class="mb-0">
                    üõ∞Ô∏è NASA Weather Probability Dashboard
                </h1>
                <p class="mb-0">Plan your outdoor activities with historical weather insights</p>
            </div>
        </div>

        <!-- Controls Panel -->
        <div class="row py-4 bg-light">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìç Location & Date Selection</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Location Input -->
                            <div class="col-md-5">
                                <label class="form-label"><i class="bi bi-geo-alt"></i> Location</label>
                                <div class="input-group mb-2">
                                    <input type="text" id="locationSearch" class="form-control" 
                                           placeholder="Enter city, country or address" 
                                           list="popularCities">
                                    <datalist id="popularCities">
                                        <option value="New York">
                                        <option value="London">
                                        <option value="Tokyo">
                                        <option value="Paris">
                                        <option value="Sydney">
                                        <option value="Dubai">
                                        <option value="Mumbai">
                                        <option value="Rio de Janeiro">
                                        <option value="Cape Town">
                                    </datalist>
                                    <button class="btn btn-primary" type="button" id="searchLocationBtn" onclick="searchLocation()">
                                        <i class="bi bi-search"></i> Search
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" id="useCurrentLocation">
                                        <i class="bi bi-geo"></i> My Location
                                    </button>
                                </div>
                                <div class="mb-2 d-flex align-items-center">
                                    <div class="location-badge p-1 px-2 bg-light border rounded d-inline-flex align-items-center">
                                        <span id="selectedLocationName">No location selected</span>
                                        <span class="ms-2 badge bg-primary rounded-pill" style="font-size:0.7rem;">
                                            <span id="selectedLat">-</span>, <span id="selectedLng">-</span>
                                        </span>
                                    </div>
                                    <button class="btn btn-sm btn-outline-success ms-2" id="saveLocationBtn" title="Save this location">
                                        <i class="bi bi-bookmark-plus"></i>
                                    </button>
                                </div>
                                
                                <!-- Saved Locations Dropdown -->
                                <div class="dropdown mt-1 mb-2">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="savedLocationsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-bookmark"></i> Saved Locations
                                    </button>
                                    <ul class="dropdown-menu" id="savedLocationsList" aria-labelledby="savedLocationsDropdown">
                                        <li><span class="dropdown-item text-muted">No saved locations</span></li>
                                    </ul>
                                </div>
                                
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Search for a city, use saved locations, or click directly on the map
                                </small>
                            </div>

                            <!-- Date Selection -->
                            <div class="col-md-3">
                                <label class="form-label">üìÖ Event Date</label>
                                <input type="date" id="targetDate" class="form-control mb-2">
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">Historical data range:</small>
                                    <select id="yearsBack" class="form-select form-select-sm" style="max-width:120px;">
                                        <option value="5">5 years</option>
                                        <option value="10" selected>10 years</option>
                                        <option value="15">15 years</option>
                                        <option value="20">20 years</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Weather Parameters -->
                            <div class="col-md-4">
                                <label class="form-label">üå¶Ô∏è Weather Conditions to Analyze</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="T2M" id="paramTemp" checked>
                                            <label class="form-check-label" for="paramTemp">
                                                <span class="d-flex align-items-center">
                                                    <i class="bi bi-thermometer-half me-1"></i> Temperature
                                                </span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="PRECTOTCORR" id="paramPrecip" checked>
                                            <label class="form-check-label" for="paramPrecip">
                                                <span class="d-flex align-items-center">
                                                    <i class="bi bi-cloud-rain me-1"></i> Precipitation
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="WS2M" id="paramWind" checked>
                                            <label class="form-check-label" for="paramWind">
                                                <span class="d-flex align-items-center">
                                                    <i class="bi bi-wind me-1"></i> Wind Speed
                                                </span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="RH2M" id="paramHumidity">
                                            <label class="form-check-label" for="paramHumidity">
                                                <span class="d-flex align-items-center">
                                                    <i class="bi bi-moisture me-1"></i> Humidity
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" id="selectAllParams">Select All</button>
                                    <button class="btn btn-sm btn-outline-secondary ms-1" type="button" id="deselectAllParams">Deselect All</button>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <button id="analyzeBtn" class="btn btn-primary btn-lg me-2">
                                    <i class="bi bi-graph-up me-1"></i> Analyze Weather Probability
                                </button>
                                <button id="exportBtn" class="btn btn-outline-success me-2" disabled>
                                    <i class="bi bi-download me-1"></i> Export Data (CSV)
                                </button>
                                <button id="showThresholdsBtn" class="btn btn-outline-info" type="button" 
                                        data-bs-toggle="modal" data-bs-target="#thresholdsModal">
                                    <i class="bi bi-info-circle me-1"></i> Weather Thresholds
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üó∫Ô∏è Select Location on Map</h5>
                    </div>
                    <div class="card-body p-0 position-relative">
                        <div id="map"></div>
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row mt-4" id="resultsSection" style="display: none;">
            <!-- Weather Probability Cards -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üéØ Weather Probability Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="probabilityCards" class="row g-3">
                            <!-- Dynamic probability cards will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="col-md-6 mt-3">
                <div class="card">
                    <div class="card-header">
                        <h6>üìà Historical Trends</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="trendChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mt-3">
                <div class="card">
                    <div class="card-header">
                        <h6>üìä Probability Distribution</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="distributionChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Comfort Index -->
            <div class="col-md-12 mt-3">
                <div class="card">
                    <div class="card-header">
                        <h6>üåà Weather Comfort Analysis</h6>
                    </div>
                    <div class="card-body">
                        <div id="comfortAnalysis">
                            <!-- Comfort index results will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Thresholds Modal -->
    <div class="modal fade" id="thresholdsModal" tabindex="-1" aria-labelledby="thresholdsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="thresholdsModalLabel">
                        <i class="bi bi-info-circle me-2"></i> Weather Condition Thresholds
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>The analysis uses these threshold values to determine different weather conditions:</p>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Parameter</th>
                                    <th>Condition</th>
                                    <th>Threshold</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td rowspan="4" class="align-middle">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-thermometer-half me-2 text-danger"></i> Temperature
                                        </div>
                                    </td>
                                    <td>Very Hot</td>
                                    <td>‚â• 35¬∞C</td>
                                    <td>Extreme heat, high risk of heat-related illnesses</td>
                                </tr>
                                <tr>
                                    <td>Hot</td>
                                    <td>‚â• 30¬∞C</td>
                                    <td>Significantly warm, uncomfortable for many activities</td>
                                </tr>
                                <tr>
                                    <td>Cold</td>
                                    <td>‚â§ 10¬∞C</td>
                                    <td>Chilly conditions requiring warm clothing</td>
                                </tr>
                                <tr>
                                    <td>Very Cold</td>
                                    <td>‚â§ 0¬∞C</td>
                                    <td>Freezing conditions with risk of hypothermia</td>
                                </tr>
                                
                                <tr>
                                    <td rowspan="3" class="align-middle">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-cloud-rain me-2 text-primary"></i> Precipitation
                                        </div>
                                    </td>
                                    <td>Wet</td>
                                    <td>‚â• 10 mm</td>
                                    <td>Noticeable rainfall that may affect outdoor activities</td>
                                </tr>
                                <tr>
                                    <td>Very Wet</td>
                                    <td>‚â• 25 mm</td>
                                    <td>Heavy rainfall, likely causing disruptions</td>
                                </tr>
                                <tr>
                                    <td>Extreme Wet</td>
                                    <td>‚â• 50 mm</td>
                                    <td>Severe rainfall with potential flooding risk</td>
                                </tr>
                                
                                <tr>
                                    <td rowspan="3" class="align-middle">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-wind me-2 text-secondary"></i> Wind Speed
                                        </div>
                                    </td>
                                    <td>Windy</td>
                                    <td>‚â• 10 m/s</td>
                                    <td>Significant wind affecting comfort</td>
                                </tr>
                                <tr>
                                    <td>Very Windy</td>
                                    <td>‚â• 15 m/s</td>
                                    <td>Strong winds with potential for minor damage</td>
                                </tr>
                                <tr>
                                    <td>Extreme Windy</td>
                                    <td>‚â• 20 m/s</td>
                                    <td>Dangerous wind conditions</td>
                                </tr>
                                
                                <tr>
                                    <td rowspan="4" class="align-middle">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-moisture me-2 text-info"></i> Humidity
                                        </div>
                                    </td>
                                    <td>Humid</td>
                                    <td>‚â• 70%</td>
                                    <td>Noticeably humid, may cause discomfort</td>
                                </tr>
                                <tr>
                                    <td>Very Humid</td>
                                    <td>‚â• 80%</td>
                                    <td>High humidity causing significant discomfort</td>
                                </tr>
                                <tr>
                                    <td>Dry</td>
                                    <td>‚â§ 30%</td>
                                    <td>Low humidity, may cause dry skin and eyes</td>
                                </tr>
                                <tr>
                                    <td>Very Dry</td>
                                    <td>‚â§ 20%</td>
                                    <td>Extremely low humidity, potential health concerns</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <h6><i class="bi bi-lightbulb me-2"></i>How We Calculate Comfort Index</h6>
                        <p class="mb-0">The comfort index combines temperature, humidity, wind speed and precipitation data to determine overall outdoor comfort. It considers factors such as heat index, wind chill, and general weather conditions to provide a comprehensive assessment of how comfortable the conditions might feel.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let map;
        let marker;
        let currentLocation = { lat: 12.97, lng: 77.59 }; // Default to Bangalore
        let analysisResults = null;
        let satelliteLayers = {};
        let baseLayersControl;
        let overlayLayersControl;
        let currentBaseLayer = null;
        let currentOverlays = {};

        // API Base URL - adjust for your FastAPI server
        const API_BASE = 'http://127.0.0.1:8082';
        
        // Saved locations for quick access
        let savedLocations = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupEventListeners();
            setDefaultDate();
            loadSatelliteLayers();
            loadSavedLocations();
        });

        function initializeMap() {
            // Initialize Leaflet map
            map = L.map('map').setView([currentLocation.lat, currentLocation.lng], 3);
            
            // Add OpenStreetMap tiles as default
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Initial base layers
            const baseLayers = {
                "OpenStreetMap": osmLayer
            };
            
            // Empty overlays to start
            const overlays = {};
            
            // Initialize layer controls
            baseLayersControl = L.control.layers(baseLayers, overlays).addTo(map);
            currentBaseLayer = osmLayer;

            // Add initial marker
            marker = L.marker([currentLocation.lat, currentLocation.lng]).addTo(map);
            updateLocationDisplay();

            // Handle map clicks
            map.on('click', function(e) {
                currentLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
                
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker([currentLocation.lat, currentLocation.lng]).addTo(map);
                
                // Try to reverse geocode the clicked location
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLocation.lat}&lon=${currentLocation.lng}&zoom=10`)
                    .then(response => response.json())
                    .then(data => {
                        let locationName = 'Selected Location';
                        
                        if (data && data.display_name) {
                            const parts = data.display_name.split(',');
                            // Get a simplified name
                            if (parts.length >= 3) {
                                locationName = parts[1].trim() + ', ' + parts[parts.length - 1].trim();
                            } else {
                                locationName = data.display_name;
                            }
                            
                            // Show in popup
                            marker.bindPopup(`<b>${data.display_name}</b>`).openPopup();
                        }
                        
                        // Update display with the name
                        updateLocationDisplay(locationName);
                    })
                    .catch(err => {
                        // If reverse geocoding fails, just show coordinates
                        updateLocationDisplay('Selected Location');
                        console.error("Error reverse geocoding:", err);
                    });
            });
        }
        
        async function loadSatelliteLayers() {
            try {
                // Show loading indicator on the map
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'satellite-loading';
                loadingDiv.innerHTML = `
                    <div style="
                        position: absolute;
                        top: 10px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: rgba(255,255,255,0.8);
                        padding: 5px 15px;
                        border-radius: 20px;
                        z-index: 1000;
                        display: flex;
                        align-items: center;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    ">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Loading NASA Satellite Layers...</span>
                    </div>
                `;
                document.getElementById('map').appendChild(loadingDiv);
                
                // Fetch available satellite layers
                const response = await fetch(`${API_BASE}/satellite/layers`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Set up NASA GIBS layers
                    setupSatelliteLayers(data.layers, data.categories);
                    
                    // Add notification
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success alert-dismissible fade show';
                    notification.setAttribute('role', 'alert');
                    notification.innerHTML = `
                        <strong>NASA Satellite Imagery Loaded!</strong> Use the layers control <i class="bi bi-layers"></i> on the map to explore different imagery.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    
                    const controlsCard = document.querySelector('.card-header');
                    if (controlsCard) {
                        controlsCard.parentNode.insertBefore(notification, controlsCard);
                        
                        // Auto dismiss after 8 seconds
                        setTimeout(() => {
                            notification.classList.remove('show');
                            setTimeout(() => notification.remove(), 500);
                        }, 8000);
                    }
                } else {
                    throw new Error('Failed to load satellite layers');
                }
            } catch (error) {
                console.error('Error loading satellite layers:', error);
                
                // Show error notification
                const errorNotification = document.createElement('div');
                errorNotification.className = 'alert alert-warning alert-dismissible fade show';
                errorNotification.setAttribute('role', 'alert');
                errorNotification.innerHTML = `
                    <strong>Satellite Imagery Unavailable</strong> Could not load NASA GIBS layers. The app will continue to work without satellite imagery.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                const controlsCard = document.querySelector('.card-header');
                if (controlsCard) {
                    controlsCard.parentNode.insertBefore(errorNotification, controlsCard);
                }
            } finally {
                // Remove loading indicator
                const loadingDiv = document.getElementById('satellite-loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }
        }
        
        function setupSatelliteLayers(layers, categories) {
            // Get current date for layer initialization
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const dateStr = yesterday.toISOString().split('T')[0]; // Format: YYYY-MM-DD
            
            // Create base layers (true color imagery)
            if (categories["Base Layers"]) {
                categories["Base Layers"].forEach(layerId => {
                    const layer = layers.find(l => l.id === layerId);
                    if (layer) {
                        // Create NASA GIBS TileLayer
                        const gibsLayer = L.tileLayer(`${API_BASE}/satellite/tile/{z}/{y}/{x}?layer=${layerId}&date=${dateStr}`, {
                            attribution: 'NASA GIBS',
                            maxZoom: 9,
                            name: layer.name,
                            id: layerId
                        });
                        
                        // Add to base layers control
                        satelliteLayers[layerId] = gibsLayer;
                        baseLayersControl.addBaseLayer(gibsLayer, `üõ∞Ô∏è ${layer.name}`);
                    }
                });
            }
            
            // Create overlay layers for weather data
            for (const [category, layerIds] of Object.entries(categories)) {
                if (category !== "Base Layers") {
                    layerIds.forEach(layerId => {
                        const layer = layers.find(l => l.id === layerId);
                        if (layer) {
                            // Create NASA GIBS overlay layer
                            const overlayLayer = L.tileLayer(`${API_BASE}/satellite/tile/{z}/{y}/{x}?layer=${layerId}&date=${dateStr}`, {
                                attribution: 'NASA GIBS',
                                maxZoom: 9,
                                opacity: 0.7,
                                transparent: true,
                                name: layer.name,
                                id: layerId
                            });
                            
                            // Add to overlay control
                            satelliteLayers[layerId] = overlayLayer;
                            
                            // Prefix with emoji based on category
                            let prefix = 'üõ∞Ô∏è';
                            if (category === 'Weather') prefix = 'üå¶Ô∏è';
                            if (category === 'Environment') prefix = 'üåø';
                            if (category === 'Night') prefix = 'üåÉ';
                            
                            baseLayersControl.addOverlay(overlayLayer, `${prefix} ${layer.name}`);
                        }
                    });
                }
            }
            
            // Add satellite date control
            addSatelliteDateControl();
        }

        function addSatelliteDateControl() {
            // Create a custom control for satellite imagery date selection
            const SatelliteDateControl = L.Control.extend({
                options: {
                    position: 'topright'
                },
                
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control satellite-date-control');
                    container.style.background = 'white';
                    container.style.padding = '8px';
                    container.style.borderRadius = '4px';
                    
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    const dateStr = yesterday.toISOString().split('T')[0];
                    
                    container.innerHTML = `
                        <div style="margin-bottom:5px;font-weight:bold;">Satellite Imagery Date</div>
                        <input type="date" id="satelliteDate" class="form-control" value="${dateStr}" max="${dateStr}">
                        <button id="updateSatelliteDate" class="btn btn-sm btn-primary mt-1">Update</button>
                    `;
                    
                    L.DomEvent.disableClickPropagation(container);
                    
                    setTimeout(() => {
                        document.getElementById('updateSatelliteDate').addEventListener('click', function() {
                            updateSatelliteLayerDate();
                        });
                    }, 500);
                    
                    return container;
                }
            });
            
            // Add the control to the map
            new SatelliteDateControl().addTo(map);
        }
        
        function updateSatelliteLayerDate() {
            const dateInput = document.getElementById('satelliteDate');
            if (!dateInput) return;
            
            const newDate = dateInput.value;
            
            // Update all satellite layers with new date
            Object.keys(satelliteLayers).forEach(layerId => {
                const layer = satelliteLayers[layerId];
                
                // Update the layer URL
                const newUrl = `${API_BASE}/satellite/tile/{z}/{y}/{x}?layer=${layerId}&date=${newDate}`;
                layer.setUrl(newUrl);
            });
            
            // Show a notification
            alert(`Satellite imagery updated to ${newDate}`);
        }

        function setupEventListeners() {
            // Analyze button
            document.getElementById('analyzeBtn').addEventListener('click', analyzeWeatherProbability);
            
            // Export button
            document.getElementById('exportBtn').addEventListener('click', exportData);
            
            // Current location button
            document.getElementById('useCurrentLocation').addEventListener('click', getCurrentLocation);
            
            // Location search (basic implementation)
            document.getElementById('locationSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });
            
            // Location search autocomplete suggestions
            document.getElementById('locationSearch').addEventListener('input', function(e) {
                suggestCities(e.target.value);
            });
            
            // Search location button
            document.getElementById('searchLocationBtn').addEventListener('click', searchLocation);
            
            // Save location button
            document.getElementById('saveLocationBtn').addEventListener('click', saveCurrentLocation);
            
            // Parameter selection
            document.getElementById('selectAllParams').addEventListener('click', function() {
                document.querySelectorAll('input[type="checkbox"][id^="param"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            });
            
            document.getElementById('deselectAllParams').addEventListener('click', function() {
                document.querySelectorAll('input[type="checkbox"][id^="param"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
            
            // Add satellite imagery tab to controls panel
            addSatelliteTab();
        }
        
        // Function to suggest cities as user types
        function suggestCities(query) {
            if (query.length < 3) return; // Only suggest after 3 characters
            
            // Throttle API calls
            if (window.lastSuggestTime && Date.now() - window.lastSuggestTime < 500) {
                clearTimeout(window.suggestTimeout);
            }
            
            window.lastSuggestTime = Date.now();
            
            window.suggestTimeout = setTimeout(() => {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                    .then(response => response.json())
                    .then(data => {
                        // Clear existing options except the built-in ones
                        const datalist = document.getElementById('popularCities');
                        const defaultCities = ['New York', 'London', 'Tokyo', 'Paris', 'Sydney', 'Dubai', 'Mumbai', 'Rio de Janeiro', 'Cape Town'];
                        
                        // Remove dynamic suggestions (keep default cities)
                        Array.from(datalist.options).forEach(option => {
                            if (!defaultCities.includes(option.value)) {
                                datalist.removeChild(option);
                            }
                        });
                        
                        // Add new suggestions
                        data.forEach(item => {
                            // Create simple display name from the complex one
                            const nameParts = item.display_name.split(',');
                            let simpleName = nameParts[0];
                            
                            if (nameParts.length > 2) {
                                // Add country or region for disambiguation
                                simpleName += ', ' + nameParts[nameParts.length - 1].trim();
                            }
                            
                            // Don't add duplicates or items in our default list
                            if (!defaultCities.includes(simpleName)) {
                                const option = document.createElement('option');
                                option.value = simpleName;
                                option.setAttribute('data-lat', item.lat);
                                option.setAttribute('data-lng', item.lon);
                                datalist.appendChild(option);
                            }
                        });
                    })
                    .catch(err => console.error('Error getting city suggestions:', err));
            }, 500);
        }
        
        // Function to save the current location
        function saveCurrentLocation() {
            const locationName = document.getElementById('selectedLocationName').textContent;
            const lat = parseFloat(document.getElementById('selectedLat').textContent);
            const lng = parseFloat(document.getElementById('selectedLng').textContent);
            
            // Check if we have a valid location
            if (locationName === 'No location selected' || isNaN(lat) || isNaN(lng)) {
                showNotification('Please select a location first', 'warning');
                return;
            }
            
            // Create location object
            const location = {
                name: locationName,
                lat: lat,
                lng: lng,
                saved: new Date().toISOString()
            };
            
            // Check if this location already exists
            const exists = savedLocations.some(loc => 
                loc.lat.toFixed(4) === lat.toFixed(4) && 
                loc.lng.toFixed(4) === lng.toFixed(4)
            );
            
            if (!exists) {
                // Add to saved locations
                savedLocations.push(location);
                
                // Save to localStorage
                localStorage.setItem('nasaWeatherSavedLocations', JSON.stringify(savedLocations));
                
                // Update the UI
                updateSavedLocationsList();
                
                // Show notification
                showNotification(`Location "${locationName}" saved successfully!`, 'success');
            } else {
                showNotification('This location is already saved', 'info');
            }
        }
        
        // Function to load saved locations from localStorage
        function loadSavedLocations() {
            const saved = localStorage.getItem('nasaWeatherSavedLocations');
            if (saved) {
                try {
                    savedLocations = JSON.parse(saved);
                    updateSavedLocationsList();
                } catch (e) {
                    console.error('Error loading saved locations:', e);
                    savedLocations = [];
                }
            }
        }
        
        // Function to update the saved locations dropdown
        function updateSavedLocationsList() {
            const list = document.getElementById('savedLocationsList');
            list.innerHTML = '';
            
            if (savedLocations.length === 0) {
                const item = document.createElement('li');
                item.innerHTML = '<span class="dropdown-item text-muted">No saved locations</span>';
                list.appendChild(item);
            } else {
                // Sort locations by name
                savedLocations.sort((a, b) => a.name.localeCompare(b.name));
                
                savedLocations.forEach((location, index) => {
                    const item = document.createElement('li');
                    const link = document.createElement('a');
                    link.className = 'dropdown-item';
                    link.href = '#';
                    link.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>${location.name}</div>
                            <button class="btn btn-sm btn-link text-danger p-0 ms-2 delete-location" 
                                    data-index="${index}" 
                                    title="Remove from saved locations">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    `;
                    
                    // Add event listener to select this location
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        selectSavedLocation(index);
                    });
                    
                    item.appendChild(link);
                    list.appendChild(item);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-location').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent triggering the parent link
                        const index = parseInt(this.getAttribute('data-index'));
                        deleteSavedLocation(index);
                    });
                });
            }
        }
        
        // Function to select a saved location
        function selectSavedLocation(index) {
            const location = savedLocations[index];
            if (location) {
                // Update current location
                currentLocation = {
                    lat: location.lat,
                    lng: location.lng
                };
                
                // Update map view
                map.setView([currentLocation.lat, currentLocation.lng], 10);
                
                // Update marker
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker([currentLocation.lat, currentLocation.lng]).addTo(map);
                
                // Update display
                updateLocationDisplay(location.name);
                
                // Show popup
                marker.bindPopup(`<b>${location.name}</b>`).openPopup();
            }
        }
        
        // Function to delete a saved location
        function deleteSavedLocation(index) {
            const location = savedLocations[index];
            if (location && confirm(`Remove "${location.name}" from your saved locations?`)) {
                savedLocations.splice(index, 1);
                
                // Save updated list to localStorage
                localStorage.setItem('nasaWeatherSavedLocations', JSON.stringify(savedLocations));
                
                // Update the UI
                updateSavedLocationsList();
                
                // Show notification
                showNotification(`Location "${location.name}" removed from saved locations`, 'info');
            }
        }
        
        // Helper function to show notifications
        function showNotification(message, type = 'info') {
            const locationCard = document.querySelector('.location-badge').closest('.col-md-5');
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show mt-2`;
            notification.setAttribute('role', 'alert');
            notification.style.fontSize = '0.9rem';
            
            // Icon based on notification type
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            if (type === 'danger') icon = 'x-circle';
            
            notification.innerHTML = `
                <i class="bi bi-${icon} me-1"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            locationCard.appendChild(notification);
            
            // Auto dismiss after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 4000);
        }
        
        function addSatelliteTab() {
            // Create a new tab for satellite imagery settings in the controls panel
            const controlsCard = document.querySelector('.card-header:contains("Location & Date Selection")');
            if (controlsCard) {
                const parentCard = controlsCard.closest('.card');
                
                if (parentCard) {
                    const satelliteTab = document.createElement('div');
                    satelliteTab.className = 'mt-3';
                    satelliteTab.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <h5>üõ∞Ô∏è Satellite Imagery</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Use the map layer control (top right) to toggle different satellite imagery layers:</p>
                                <ul class="mb-3">
                                    <li><strong>Base Layers:</strong> True color satellite imagery</li>
                                    <li><strong>Weather Overlays:</strong> Clouds, precipitation, temperature</li>
                                    <li><strong>Environment:</strong> Vegetation, snow cover, air quality</li>
                                </ul>
                                <p class="text-muted">Select a different date using the date control on the map.</p>
                            </div>
                        </div>
                    `;
                    
                    parentCard.parentNode.insertBefore(satelliteTab, parentCard.nextSibling);
                }
            }
        }

        function setDefaultDate() {
            // Set default date to 3 months from now
            const future = new Date();
            future.setMonth(future.getMonth() + 3);
            document.getElementById('targetDate').value = future.toISOString().split('T')[0];
        }

        function updateLocationDisplay(locationName = '') {
            document.getElementById('selectedLat').textContent = currentLocation.lat.toFixed(4);
            document.getElementById('selectedLng').textContent = currentLocation.lng.toFixed(4);
            
            // Update location name if provided
            if (locationName) {
                document.getElementById('selectedLocationName').textContent = locationName;
            } else {
                // Otherwise just display coordinates as the name
                document.getElementById('selectedLocationName').textContent = `Selected Location`;
            }
            
            // Add a highlight effect to show that the location has been updated
            const badge = document.querySelector('.location-badge');
            badge.classList.add('bg-light', 'border-primary');
            setTimeout(() => {
                badge.classList.remove('bg-light', 'border-primary');
            }, 2000);
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                // Update button to show loading
                const locationBtn = document.getElementById('useCurrentLocation');
                const originalBtnHtml = locationBtn.innerHTML;
                locationBtn.disabled = true;
                locationBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Locating...';
                
                navigator.geolocation.getCurrentPosition(
                    // Success callback
                    function(position) {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Update map view
                        map.setView([currentLocation.lat, currentLocation.lng], 12);
                        
                        // Update marker
                        if (marker) {
                            map.removeLayer(marker);
                        }
                        marker = L.marker([currentLocation.lat, currentLocation.lng]).addTo(map);
                        
                        // Try to reverse geocode the location to get a name
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLocation.lat}&lon=${currentLocation.lng}&zoom=10`)
                            .then(response => response.json())
                            .then(data => {
                                let locationName = 'Your Location';
                                
                                if (data && data.display_name) {
                                    const parts = data.display_name.split(',');
                                    // Try to get a reasonable name (city + country)
                                    if (parts.length >= 3) {
                                        locationName = parts[1].trim() + ', ' + parts[parts.length - 1].trim();
                                    } else {
                                        locationName = data.display_name;
                                    }
                                    
                                    // Show in popup
                                    marker.bindPopup(`<b>${data.display_name}</b>`).openPopup();
                                }
                                
                                // Update display with the name
                                updateLocationDisplay(locationName);
                            })
                            .catch(err => {
                                // If reverse geocoding fails, just show coordinates
                                updateLocationDisplay('Your Current Location');
                                console.error("Error reverse geocoding:", err);
                            })
                            .finally(() => {
                                // Reset the button
                                locationBtn.disabled = false;
                                locationBtn.innerHTML = originalBtnHtml;
                            });
                    },
                    // Error callback
                    function(error) {
                        // Reset the button
                        locationBtn.disabled = false;
                        locationBtn.innerHTML = originalBtnHtml;
                        
                        let errorMsg = 'Unable to retrieve your location.';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = 'Location access was denied by the user.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = 'Location information is unavailable.';
                                break;
                            case error.TIMEOUT:
                                errorMsg = 'The request to get user location timed out.';
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMsg = 'An unknown error occurred while getting location.';
                                break;
                        }
                        
                        // Show error notification
                        const locationCard = document.querySelector('.location-badge').closest('.col-md-5');
                        const errorNotification = document.createElement('div');
                        errorNotification.className = 'alert alert-warning alert-dismissible fade show mt-2';
                        errorNotification.setAttribute('role', 'alert');
                        errorNotification.style.fontSize = '0.9rem';
                        errorNotification.innerHTML = `
                            <i class="bi bi-exclamation-triangle me-1"></i> ${errorMsg}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        
                        locationCard.appendChild(errorNotification);
                        
                        // Auto dismiss after 5 seconds
                        setTimeout(() => {
                            errorNotification.classList.remove('show');
                            setTimeout(() => {
                                if (errorNotification.parentNode) {
                                    errorNotification.parentNode.removeChild(errorNotification);
                                }
                            }, 500);
                        }, 5000);
                    },
                    // Options
                    { 
                        enableHighAccuracy: true, 
                        timeout: 10000, 
                        maximumAge: 0 
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        function searchLocation() {
            // Implement Nominatim OpenStreetMap search for geocoding
            const query = document.getElementById('locationSearch').value;
            if (!query.trim()) {
                showNotification('Please enter a location to search', 'warning');
                return;
            }
            
            // Show loading indicator
            const searchInput = document.getElementById('locationSearch');
            const originalValue = searchInput.value;
            searchInput.disabled = true;
            searchInput.value = "Searching...";
            
            // Show spinner in button
            const searchBtn = document.getElementById('searchLocationBtn');
            const originalBtnHtml = searchBtn.innerHTML;
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Searching...';
            
            // Check if we have multiple results - if so, show a modal to select
            const searchParams = new URLSearchParams({
                format: 'json',
                q: query,
                limit: 5,
                addressdetails: 1
            });
            
            // Use OpenStreetMap Nominatim API for geocoding
            fetch(`https://nominatim.openstreetmap.org/search?${searchParams.toString()}`)
                .then(response => response.json())
                .then(data => {
                    // Reset input and button
                    searchInput.disabled = false;
                    searchInput.value = originalValue;
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = originalBtnHtml;
                    
                    if (data && data.length > 0) {
                        if (data.length === 1) {
                            // Just one result, use it directly
                            processGeocodingResult(data[0]);
                        } else {
                            // Multiple results, show selection modal
                            showLocationSelectionModal(data);
                        }
                    } else {
                        showNotification('Location not found. Please try a different search.', 'warning');
                    }
                })
                .catch(error => {
                    console.error('Error searching location:', error);
                    searchInput.disabled = false;
                    searchInput.value = originalValue;
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = originalBtnHtml;
                    
                    showNotification('Error searching for location. Please try again.', 'danger');
                });
        }
        
        // Process a selected geocoding result
        function processGeocodingResult(result) {
            // Update current location
            currentLocation = {
                lat: parseFloat(result.lat),
                lng: parseFloat(result.lon)
            };
            
            // Update map view
            map.setView([currentLocation.lat, currentLocation.lng], 10);
            
            // Update marker
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([currentLocation.lat, currentLocation.lng]).addTo(map);
            
            // Create a formatted display name
            let displayName = '';
            
            // Try to use address components for better formatting if available
            if (result.address) {
                const address = result.address;
                const components = [];
                
                // Prioritize certain components
                if (address.city) components.push(address.city);
                else if (address.town) components.push(address.town);
                else if (address.village) components.push(address.village);
                else if (address.hamlet) components.push(address.hamlet);
                
                // Add county/state if available and different from city
                if (address.county && !components.includes(address.county)) 
                    components.push(address.county);
                else if (address.state && !components.includes(address.state)) 
                    components.push(address.state);
                
                // Always add country as last component
                if (address.country && !components.includes(address.country)) 
                    components.push(address.country);
                
                displayName = components.join(', ');
            }
            
            // Fallback to splitting display_name if address components not available
            if (!displayName) {
                const locationParts = result.display_name.split(',');
                displayName = locationParts[0];
                if (locationParts.length > 1) {
                    displayName += ', ' + locationParts[locationParts.length - 1].trim();
                }
            }
            
            // Show location name as popup
            marker.bindPopup(`<b>${result.display_name}</b>`).openPopup();
            
            // Update display with the name
            updateLocationDisplay(displayName);
            
            // Show success notification
            showNotification(`Location found: <strong>${displayName}</strong>`, 'success');
            
            // Clear the search input
            document.getElementById('locationSearch').value = '';
        }
        
        // Show a modal with multiple location options
        function showLocationSelectionModal(results) {
            // Create modal element if it doesn't exist
            let modal = document.getElementById('locationSelectionModal');
            
            if (!modal) {
                const modalHTML = `
                    <div class="modal fade" id="locationSelectionModal" tabindex="-1" aria-labelledby="locationSelectionModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="locationSelectionModalLabel">
                                        <i class="bi bi-geo-alt me-2"></i>Select Location
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Multiple locations found. Please select one:</p>
                                    <div class="list-group" id="locationOptions">
                                        <!-- Location options will be inserted here -->
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHTML;
                document.body.appendChild(modalContainer.firstChild);
                modal = document.getElementById('locationSelectionModal');
            }
            
            // Populate location options
            const locationOptions = document.getElementById('locationOptions');
            locationOptions.innerHTML = '';
            
            results.forEach((result, index) => {
                // Format the location name
                let locationName = '';
                let details = '';
                
                // Try to use address components for better formatting
                if (result.address) {
                    const address = result.address;
                    const mainComponents = [];
                    const detailComponents = [];
                    
                    // Main components
                    if (address.city) mainComponents.push(address.city);
                    else if (address.town) mainComponents.push(address.town);
                    else if (address.village) mainComponents.push(address.village);
                    else if (address.hamlet) mainComponents.push(address.hamlet);
                    
                    // If we have state/country, add those
                    if (address.state) mainComponents.push(address.state);
                    if (address.country) mainComponents.push(address.country);
                    
                    // Detail components
                    if (address.road) detailComponents.push(address.road);
                    if (address.suburb) detailComponents.push(address.suburb);
                    if (address.county && !mainComponents.includes(address.county)) 
                        detailComponents.push(address.county);
                    
                    locationName = mainComponents.join(', ');
                    details = detailComponents.join(', ');
                }
                
                // Fallback to display_name if address parsing failed
                if (!locationName) {
                    const parts = result.display_name.split(',');
                    locationName = parts.slice(0, Math.min(2, parts.length)).join(',');
                    details = parts.slice(Math.min(2, parts.length)).join(',');
                }
                
                // Type of location (city, building, etc)
                const locationType = result.type.charAt(0).toUpperCase() + result.type.slice(1);
                
                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action';
                item.href = '#';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${locationName}</h6>
                            <p class="mb-1 text-muted small">${details}</p>
                            <small class="text-muted">${locationType}</small>
                        </div>
                        <span class="badge bg-light text-dark rounded-pill">
                            ${result.lat.substring(0, 6)}, ${result.lon.substring(0, 6)}
                        </span>
                    </div>
                `;
                
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Hide modal
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    modalInstance.hide();
                    // Process selected location
                    processGeocodingResult(result);
                });
                
                locationOptions.appendChild(item);
            });
            
            // Show the modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        }

        async function analyzeWeatherProbability() {
            const targetDate = document.getElementById('targetDate').value;
            const yearsBack = parseInt(document.getElementById('yearsBack').value);
            
            if (!targetDate) {
                showNotification('Please select a target date', 'warning');
                return;
            }

            // Get selected parameters
            const parameters = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                parameters.push(checkbox.value);
            });

            if (parameters.length === 0) {
                showNotification('Please select at least one weather parameter', 'warning');
                return;
            }

            // Show loading
            showLoading(true);
            
            try {
                // Convert date to MMDD format
                const date = new Date(targetDate);
                const monthDay = String(date.getMonth() + 1).padStart(2, '0') + 
                               String(date.getDate()).padStart(2, '0');

                // Define thresholds for analysis
                const thresholds = {
                    'T2M': { 'very_hot': 35, 'hot': 30, 'cold': 10, 'very_cold': 0 },
                    'PRECTOTCORR': { 'wet': 10, 'very_wet': 25, 'extreme_wet': 50 },
                    'WS2M': { 'windy': 10, 'very_windy': 15, 'extreme_windy': 20 },
                    'RH2M': { 'humid': 70, 'very_humid': 80, 'dry': 30, 'very_dry': 20 }
                };

                const requestData = {
                    latitude: currentLocation.lat,
                    longitude: currentLocation.lng,
                    target_date: monthDay,
                    years_back: yearsBack,
                    parameters: parameters,
                    thresholds: thresholds
                };

                const response = await fetch(`${API_BASE}/weather/probability`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                analysisResults = await response.json();
                
                try {
                    // Wrap display results in try/catch to handle any chart rendering errors
                    displayResults(analysisResults);
                } catch (displayError) {
                    console.error('Error displaying results:', displayError);
                    // Destroy any potentially corrupted charts
                    if (trendChartInstance) {
                        trendChartInstance.destroy();
                        trendChartInstance = null;
                    }
                    if (distributionChartInstance) {
                        distributionChartInstance.destroy();
                        distributionChartInstance = null;
                    }
                    throw new Error('Error rendering charts: ' + displayError.message);
                }
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error analyzing weather data: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function displayResults(results) {
            // Clear previous results to ensure no conflicts
            clearPreviousResults();
            
            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
            
            // Enable export button
            document.getElementById('exportBtn').disabled = false;
            
            // Display probability cards
            displayProbabilityCards(results.results);
            
            // Display charts
            displayCharts(results.results);
            
            // Display comfort analysis if available
            if (results.results.comfort_index) {
                displayComfortAnalysis(results.results.comfort_index);
            }
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Function to clear previous results to avoid conflicts
        function clearPreviousResults() {
            // Clear probability cards
            document.getElementById('probabilityCards').innerHTML = '';
            
            // Clear comfort analysis
            document.getElementById('comfortAnalysis').innerHTML = '';
            
            // Charts will be destroyed in their respective create functions
        }

        function displayProbabilityCards(results) {
            const container = document.getElementById('probabilityCards');
            container.innerHTML = '';

            Object.keys(results).forEach(param => {
                if (param === 'comfort_index') return;
                
                const data = results[param];
                const card = createProbabilityCard(param, data);
                container.appendChild(card);
            });
        }

        function createProbabilityCard(parameter, data) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';

            const paramNames = {
                'T2M': 'üå°Ô∏è Temperature',
                'PRECTOTCORR': 'üåßÔ∏è Precipitation', 
                'WS2M': 'üí® Wind Speed',
                'RH2M': 'üíß Humidity'
            };

            let probabilitiesHtml = '';
            Object.entries(data.probabilities || {}).forEach(([condition, prob]) => {
                const cssClass = prob > 50 ? 'probability-high' : 
                               prob > 20 ? 'probability-medium' : 'probability-low';
                
                probabilitiesHtml += `
                    <div class="d-flex justify-content-between">
                        <span>${condition.replace('_', ' ')}</span>
                        <span class="${cssClass}">${prob}%</span>
                    </div>
                `;
            });

            col.innerHTML = `
                <div class="card weather-card h-100">
                    <div class="card-header">
                        <h6>${paramNames[parameter] || parameter}</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">Historical Average</small>
                            <h5>${data.statistics?.mean?.toFixed(1) || 'N/A'} ${data.unit}</h5>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">Probability of Conditions</small>
                            ${probabilitiesHtml}
                        </div>
                        
                        <div class="text-muted small">
                            Based on ${data.statistics?.count || 0} data points
                        </div>
                    </div>
                </div>
            `;

            return col;
        }

        // Store chart instances so they can be destroyed before creating new ones
        let trendChartInstance = null;
        let distributionChartInstance = null;
        
        function displayCharts(results) {
            // Historical trends chart
            createTrendChart(results);
            
            // Probability distribution chart
            createDistributionChart(results);
        }

        function createTrendChart(results) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (trendChartInstance) {
                trendChartInstance.destroy();
                trendChartInstance = null;
            }
            
            // Extract data for the first parameter as example
            const firstParam = Object.keys(results).find(key => key !== 'comfort_index');
            if (!firstParam) return;
            
            const data = results[firstParam];
            
            // Create new chart and store the instance
            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.historical_values?.map((_, i) => `Point ${i+1}`) || [],
                    datasets: [{
                        label: firstParam,
                        data: data.historical_values || [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function createDistributionChart(results) {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (distributionChartInstance) {
                distributionChartInstance.destroy();
                distributionChartInstance = null;
            }
            
            // Create probability comparison chart
            const labels = [];
            const datasets = [];
            
            Object.entries(results).forEach(([param, data]) => {
                if (param === 'comfort_index') return;
                
                const probabilities = data.probabilities || {};
                Object.keys(probabilities).forEach(condition => {
                    if (!labels.includes(condition)) {
                        labels.push(condition);
                    }
                });
            });

            const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'];
            let colorIndex = 0;

            Object.entries(results).forEach(([param, data]) => {
                if (param === 'comfort_index') return;
                
                const probData = labels.map(label => data.probabilities?.[label] || 0);
                
                datasets.push({
                    label: param,
                    data: probData,
                    backgroundColor: colors[colorIndex % colors.length],
                    borderWidth: 1
                });
                colorIndex++;
            });

            // Create new chart and store the instance
            distributionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function displayComfortAnalysis(comfortData) {
            const container = document.getElementById('comfortAnalysis');
            
            const probabilities = comfortData.comfort_probabilities || {};
            
            // Determine the most likely comfort level
            let maxProb = 0;
            let likelyComfort = '';
            
            Object.entries(probabilities).forEach(([condition, prob]) => {
                if (prob > maxProb) {
                    maxProb = prob;
                    likelyComfort = condition;
                }
            });
            
            // Generate recommendation text based on most likely comfort
            let recommendationText = '';
            let recommendationClass = '';
            
            switch(likelyComfort) {
                case 'very_comfortable':
                    recommendationText = 'Perfect conditions for outdoor activities! This is an ideal time for your planned activities.';
                    recommendationClass = 'text-success';
                    break;
                case 'comfortable':
                    recommendationText = 'Good conditions overall. You may want to bring a light jacket or sun protection depending on the season.';
                    recommendationClass = 'text-info';
                    break;
                case 'uncomfortable':
                    recommendationText = 'Be prepared for potentially challenging weather. Consider rescheduling or bringing appropriate gear.';
                    recommendationClass = 'text-warning';
                    break;
                case 'very_uncomfortable':
                    recommendationText = 'Weather conditions likely to be difficult. We recommend choosing an alternative date if possible.';
                    recommendationClass = 'text-danger';
                    break;
                default:
                    recommendationText = 'Insufficient data to make a comfort recommendation.';
                    recommendationClass = 'text-secondary';
            }
            
            container.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                            <div class="display-6 text-success">${probabilities.very_comfortable || 0}%</div>
                            <div class="d-flex align-items-center justify-content-center">
                                <i class="bi bi-emoji-laughing me-1"></i>
                                <span>Very Comfortable</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-info bg-opacity-10 rounded">
                            <div class="display-6 text-info">${probabilities.comfortable || 0}%</div>
                            <div class="d-flex align-items-center justify-content-center">
                                <i class="bi bi-emoji-smile me-1"></i>
                                <span>Comfortable</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-warning bg-opacity-10 rounded">
                            <div class="display-6 text-warning">${probabilities.uncomfortable || 0}%</div>
                            <div class="d-flex align-items-center justify-content-center">
                                <i class="bi bi-emoji-frown me-1"></i>
                                <span>Uncomfortable</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-danger bg-opacity-10 rounded">
                            <div class="display-6 text-danger">${probabilities.very_uncomfortable || 0}%</div>
                            <div class="d-flex align-items-center justify-content-center">
                                <i class="bi bi-emoji-angry me-1"></i>
                                <span>Very Uncomfortable</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 p-3 border-start border-4 ${recommendationClass} bg-light">
                    <div class="d-flex">
                        <div class="me-3">
                            <i class="bi bi-info-circle-fill ${recommendationClass} fs-3"></i>
                        </div>
                        <div>
                            <h5 class="${recommendationClass}">Recommendation</h5>
                            <p>${recommendationText}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 text-center text-muted">
                    <small>Comfort index calculation based on temperature, humidity, wind speed and precipitation combination</small>
                </div>
            `;
        }

        function showLoading(show) {
            const spinner = document.querySelector('.loading-spinner');
            spinner.style.display = show ? 'block' : 'none';
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = show;
            analyzeBtn.innerHTML = show ? 
                '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...' :
                '<i class="bi bi-graph-up me-1"></i> Analyze Weather Probability';
        }

        async function exportData() {
            if (!analysisResults) {
                alert('No data available to export');
                return;
            }

            try {
                const targetDate = document.getElementById('targetDate').value;
                const date = new Date(targetDate);
                
                // Calculate date range for export (using same year for simplicity)
                const startDate = date.getFullYear() + '0101';
                const endDate = date.getFullYear() + '1231';
                
                const parameters = [];
                document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    parameters.push(checkbox.value);
                });

                const exportUrl = `${API_BASE}/weather/export/csv?` + new URLSearchParams({
                    latitude: currentLocation.lat,
                    longitude: currentLocation.lng,
                    start_date: startDate,
                    end_date: endDate,
                    parameters: parameters.join(',')
                });

                // Download the file
                window.open(exportUrl, '_blank');
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data: ' + error.message);
            }
        }
    </script>
</body>
</html>